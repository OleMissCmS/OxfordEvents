<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Discover concerts, athletics, community gatherings, arts, and more happening in Oxford, Mississippi.">
    <title>Oxford Happenings - Upcoming in Oxford</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
    <header class="site-header">
        <a class="site-logo" href="{{ url_for('index') }}">
            Oxford Happenings
        </a>
        <a class="auth-link" href="{{ url_for('signup') }}">Log In / Sign Up</a>
    </header>

    <!-- Hero Carousel Section -->
    <div class="hero-carousel">
        <div class="carousel-slide active" style="background-image: linear-gradient(rgba(19, 41, 75, 0.7), rgba(19, 41, 75, 0.7)), url('https://images.unsplash.com/photo-1511578314322-379afb476865?w=1920&q=80');">
            <div class="carousel-content">
                <h1 class="carousel-title">Discover What's Happening in Oxford</h1>
                <p class="carousel-subtitle">Your guide to concerts, athletics, community gatherings, arts, and more</p>
            </div>
        </div>
        <div class="carousel-slide" style="background-image: linear-gradient(rgba(19, 41, 75, 0.7), rgba(19, 41, 75, 0.7)), url('https://images.unsplash.com/photo-1505373877841-8d25f7d46678?w=1920&q=80');">
            <div class="carousel-content">
                <h1 class="carousel-title">Experience Oxford's Vibrant Community</h1>
                <p class="carousel-subtitle">From Ole Miss Athletics to local music venues</p>
            </div>
        </div>
        <div class="carousel-slide" style="background-image: linear-gradient(rgba(19, 41, 75, 0.7), rgba(19, 41, 75, 0.7)), url('https://images.unsplash.com/photo-1514525253161-7a46d19cd819?w=1920&q=80');">
            <div class="carousel-content">
                <h1 class="carousel-title">Never Miss a Moment</h1>
                <p class="carousel-subtitle">Stay connected with Oxford's cultural scene</p>
            </div>
        </div>
        <div class="carousel-indicators">
            <span class="indicator active" data-slide="0"></span>
            <span class="indicator" data-slide="1"></span>
            <span class="indicator" data-slide="2"></span>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Hero Section -->
        <div class="hero">
            <div class="hero-header">
                <h1>Oxford Happenings</h1>
                <div class="hero-actions">
                    <a class="hero-link" href="{{ url_for('submit_event') }}">
                        <i class="fas fa-plus-circle"></i> Submit a Happening
                    </a>
                </div>
            </div>
            <p>Browse concerts, athletics, community gatherings, arts, and more happening in and around Oxford over the next few weeks.</p>
            <!-- Loading Status -->
            <div id="loadingStatus" class="loading-status hidden">
                <span id="statusText">Loading events...</span>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-controls">
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchInput" placeholder="Search happenings..." aria-label="Search events">
                </div>
                <div class="advanced-filters-toggle">
                    <button id="advancedFiltersBtn" class="btn-filter-toggle" aria-label="Show advanced filters">
                        <i class="fas fa-filter"></i> Advanced Filters
                    </button>
                </div>
                <div class="date-filter date-filter-inline">
                    <label for="dateRangeStart" class="date-filter-label"><i class="fas fa-calendar-alt"></i> Start date</label>
                    <input type="date" id="dateRangeStart" class="date-filter-input" aria-label="Start date">
                    <label for="dateRangeEnd" class="date-filter-label"><i class="fas fa-calendar-alt"></i> End date</label>
                    <input type="date" id="dateRangeEnd" class="date-filter-input" aria-label="End date">
                    <div id="dateFilterWarning" class="date-warning hidden">Fetching happenings beyond our current 3-week window. This may take a moment…</div>
                    <div id="dateFilterStatus" class="date-status hidden"></div>
                </div>
            </div>
            <!-- Advanced Filters Panel -->
            <div id="advancedFiltersPanel" class="advanced-filters-panel hidden">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="locationFilter"><i class="fas fa-map-marker-alt"></i> Location</label>
                        <select id="locationFilter" class="filter-select" aria-label="Filter by location">
                            <option value="">All Locations</option>
                            <option value="grove">The Grove</option>
                            <option value="library">J.D. Williams Library</option>
                            <option value="square">Oxford Square</option>
                            <option value="stadium">Vaught-Hemingway Stadium</option>
                            <option value="tad-smith">Tad Smith Coliseum</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="priceFilter"><i class="fas fa-dollar-sign"></i> Price</label>
                        <select id="priceFilter" class="filter-select" aria-label="Filter by price">
                            <option value="">All Prices</option>
                            <option value="free">Free Only</option>
                            <option value="paid">Paid Events</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="accessibilityFilter"><i class="fas fa-wheelchair"></i> Accessibility</label>
                        <select id="accessibilityFilter" class="filter-select" aria-label="Filter by accessibility">
                            <option value="">All Events</option>
                            <option value="accessible">Wheelchair Accessible</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="sortBy"><i class="fas fa-sort"></i> Sort By</label>
                        <select id="sortBy" class="filter-select" aria-label="Sort events">
                            <option value="date">Date (Earliest First)</option>
                            <option value="date-desc">Date (Latest First)</option>
                            <option value="popularity">Popularity</option>
                            <option value="title">Title (A-Z)</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="filter-chips" id="filterChips">
                <button class="filter-pill active filter-pill-all" data-category="All">
                    <span class="pill-label">All</span>
                </button>
                {% for category in categories %}
                <button class="filter-pill" data-category="{{ category }}">
                    <span class="pill-label">{{ category }}</span>
                    <span class="pill-divider" aria-hidden="true">|</span>
                    <span class="pill-dismiss" role="button" tabindex="0" aria-label="Hide {{ category }}">×</span>
                </button>
                {% endfor %}
            </div>
        </div>

        <!-- Stats Section -->
        <div class="stats-section">
            <div class="stats-header">Over the next three weeks...</div>
            <div class="stat">
                <div class="stat-number">{{ total_events }}</div>
                <div class="stat-label">Total Events</div>
            </div>
            <div class="stat">
                <div class="stat-number">{{ (events|selectattr('cost', 'equalto', 'Free')|list)|length }}</div>
                <div class="stat-label">Free Events</div>
            </div>
            <div class="stat">
                <div class="stat-number">{{ categories|length }}</div>
                <div class="stat-label">Categories</div>
            </div>
            <div class="stat">
                <div class="stat-number">{{ num_sources }}</div>
                <div class="stat-label">Sources</div>
            </div>
        </div>

        <!-- Events Grid -->
        <div class="events-grid" id="eventsGrid">
            {% for event in events %}
            {% set detail_link = event.info_url or event.link %}
            {% set is_free = event.cost and 'Free' in event.cost %}
            {% set is_today = event.start_iso and event.start_iso[:10] == today %}
            {% set weekday = event.start_iso|format_weekday if event.start_iso else '' %}
            {% set time_str = event.start_iso|format_time if event.start_iso else '' %}
            {% set is_weekend = event.start_iso|is_weekend if event.start_iso else False %}
            {% set is_ole_miss_athletics = 'Ole Miss Athletics' in event.category %}
            {% set is_ice_hockey = 'ice hockey' in event.title|lower %}
            {% set use_sports_composite = is_ole_miss_athletics or is_ice_hockey %}
            {% set fallback_image = url_for('static', filename='images/fallbacks/default.jpg') %}
            {% set card_image = event.display_image or fallback_image %}
            {% set cost_str = event.cost or 'Free' %}
            {% set cost_badge = '' %}
            {% if not is_free and cost_str != 'Free' and cost_str != 'Varies' %}
                {% if '-' in cost_str %}
                    {% set cost_badge = cost_str %}
                {% elif cost_str.startswith('$') %}
                    {% set cost_badge = 'From ' + cost_str %}
                {% else %}
                    {% set cost_badge = cost_str %}
                {% endif %}
            {% endif %}
            <div class="event-card" 
                 data-category="{{ event.category }}" 
                 data-title="{{ event.title|lower }}" 
                 data-location="{{ event.location|lower }}" 
                 data-start="{{ event.start_iso }}"
                 data-cost="{{ event.cost or 'Free' }}"
                 data-event-id="{{ loop.index0 }}"
                 onclick="openEventModal({{ loop.index0 }})">
                <div class="event-image-container">
                    {% set matchup = get_matchup_data(event) %}
                    {% if matchup and matchup.has_logos and use_sports_composite %}
                    {% set event_hash = event.get('hash', '') %}
                    {% set image_url = url_for('sports_image', title=event.title|urlencode) %}
                    {% if event_hash %}
                    {% set image_url = image_url + '?hash=' + event_hash + '&date=' + (event.start_iso|urlencode if event.start_iso else '') + '&location=' + (event.location|urlencode if event.location else '') %}
                    {% else %}
                    {% set image_url = image_url + '?date=' + (event.start_iso|urlencode if event.start_iso else '') + '&location=' + (event.location|urlencode if event.location else '') %}
                    {% endif %}
                    <img src="{{ image_url }}" 
                         alt="{{ event.title }}" 
                         class="event-image"
                         loading="lazy">
                    {% elif matchup and matchup.has_logos %}
                    <div class="matchup-graphic">
                        <div class="matchup-team matchup-away">
                            <img src="{{ matchup.away_logo }}" alt="{{ matchup.opponent }}" class="matchup-logo" onerror="this.style.display='none'">
                            <span class="matchup-team-name">{{ matchup.opponent }}</span>
                        </div>
                        <div class="matchup-vs">VS</div>
                        <div class="matchup-team matchup-home">
                            <img src="{{ matchup.home_logo }}" alt="Ole Miss" class="matchup-logo" onerror="this.style.display='none'">
                            <span class="matchup-team-name">Ole Miss</span>
                        </div>
                    </div>
                    {% else %}
                    <img src="{{ card_image }}"
                         alt="{{ event.title }}"
                         class="event-image"
                         loading="lazy"
                         onerror="this.onerror=null; this.src='{{ fallback_image }}'">
                    {% endif %}
                    <div class="event-badges">
                        <div class="badge-slot badge-slot-left">
                            {% if is_free %}
                            <span class="badge badge-free">Free</span>
                            {% elif cost_badge %}
                            <span class="badge badge-cost">{{ cost_badge }}</span>
                            {% endif %}
                        </div>
                        <div class="badge-slot badge-slot-right">
                            {% if is_today %}
                            <span class="badge badge-today">Today</span>
                            {% elif is_weekend %}
                            <span class="badge badge-weekend">This Weekend</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="event-content">
                    {# Date line - small uppercase weekday #}
                    {% if weekday %}
                    <div class="event-date-line">{{ weekday }}</div>
                    {% endif %}
                    <h3 class="event-title">
                        {% if detail_link %}
                        <a href="{{ detail_link }}" target="_blank" rel="noopener" onclick="event.stopPropagation()">{{ event.title }}</a>
                        {% else %}
                        {{ event.title }}
                        {% endif %}
                    </h3>
                    {% if time_str %}
                    <div class="event-time">{{ time_str }}</div>
                    {% endif %}
                    <div class="event-venue">{{ event.location }}</div>
                    {# Description - 2-3 lines max, truncate #}
                    <div class="event-description">{{ event.description|truncate_description }}</div>
                    {# Footer with actions #}
                    <div class="event-footer">
                        <div class="event-actions">
                            <button class="btn-details" onclick="event.stopPropagation(); openEventModal({{ loop.index0 }})">
                                <i class="fas fa-info-circle"></i> View Details
                            </button>
                            <button class="share-btn" onclick="event.stopPropagation(); shareEvent({{ loop.index0 }})" aria-label="Share event">
                                <i class="fas fa-share-alt"></i> Share
                            </button>
                            {% if event.tickets_url %}
                            <a href="{{ event.tickets_url }}" class="btn-tickets" target="_blank" rel="noopener" onclick="event.stopPropagation()">
                                <i class="fas fa-ticket-alt"></i> Tickets
                            </a>
                            {% elif event.cost and event.cost != 'Free' and detail_link %}
                            <a href="{{ detail_link }}" class="btn-tickets" target="_blank" rel="noopener" onclick="event.stopPropagation()">
                                <i class="fas fa-ticket-alt"></i> Tickets
                            </a>
                            {% endif %}
                        </div>
                        <div class="calendar-links">
                            <a href="{{ event|google_calendar_link }}" target="_blank" class="calendar-btn google-cal" onclick="event.stopPropagation()">
                                <i class="fab fa-google"></i> Google
                            </a>
                            <a href="{{ event|ics_calendar_link }}" class="calendar-btn apple-cal" onclick="event.stopPropagation()">
                                <i class="fab fa-apple"></i> Apple
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Footer -->
        <div class="footer">
            Last updated: Just now | {{ num_sources }} sources
        </div>
    </div>

    <!-- Event Details Modal -->
    <div id="eventModal" class="event-modal hidden">
        <div class="modal-overlay" onclick="closeEventModal()"></div>
        <div class="modal-content">
            <button class="modal-close" onclick="closeEventModal()" aria-label="Close modal">
                <i class="fas fa-times"></i>
            </button>
            <div id="modalBody" class="modal-body">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Calendar View Container (hidden by default) -->
    <div id="calendarView" class="calendar-view hidden">
        <div class="calendar-container">
            <div class="calendar-header">
                <button id="prevMonth" class="calendar-nav-btn">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <h2 id="calendarMonthYear"></h2>
                <button id="nextMonth" class="calendar-nav-btn">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <div id="calendarGrid" class="calendar-grid">
                <!-- Calendar will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Pass event data to JavaScript
        const eventsData = [
            {% for event in events %}
            {
                id: {{ loop.index0 }},
                title: {{ event.title|tojson }},
                start_iso: {{ event.start_iso|tojson }},
                location: {{ event.location|tojson }},
                description: {{ (event.description or '')|tojson }},
                cost: {{ (event.cost or 'Free')|tojson }},
                category: {{ event.category|tojson }},
                info_url: {{ (event.info_url or '')|tojson }},
                tickets_url: {{ (event.tickets_url or '')|tojson }},
                link: {{ (event.link or '')|tojson }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];
    </script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>

